!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e=0,t=0,r=0,n=1){this.x=e,this.y=t,this.z=r,this.w=n}perspectiveDivide(){const{x:e,y:t,z:r,w:o}=this;return new n(e/o,t/o,r/o)}minus(e){const{x:t,y:r,z:o,w:s}=this;return new n(t-e.x,r-e.y,o-e.z,s)}plus(e){const{x:t,y:r,z:o,w:s}=this;return new n(t+e.x,r+e.y,o+e.z,s)}times(e){const{x:t,y:r,z:o,w:s}=this;return new n(t*e,r*e,o*e,s)}dot(e){const{x:t,y:r,z:n,w:o}=this;return t*e.x+r*e.y+n*e.z}normalize(){const{x:e,y:t,z:r,w:o}=this,s=Math.sqrt(e*e+t*t+r*r);return new n(e/s,t/s,r/s,o)}static fromVectorOrCoords(e,t,r){return r=e instanceof n?e.z:r||0,t=e instanceof n?e.y:t||0,e=e instanceof n?e.x:e,new n(e,t,r)}}t.Vector3D=n},function(e,t,r){"use strict";r.r(t),r.d(t,"h",function(){return a}),r.d(t,"createElement",function(){return a}),r.d(t,"cloneElement",function(){return u}),r.d(t,"Component",function(){return z}),r.d(t,"render",function(){return N}),r.d(t,"rerender",function(){return f}),r.d(t,"options",function(){return o});var n=function(){},o={},s=[],i=[];function a(e,t){var r,a,c,l,u=i;for(l=arguments.length;l-- >2;)s.push(arguments[l]);for(t&&null!=t.children&&(s.length||s.push(t.children),delete t.children);s.length;)if((a=s.pop())&&void 0!==a.pop)for(l=a.length;l--;)s.push(a[l]);else"boolean"==typeof a&&(a=null),(c="function"!=typeof e)&&(null==a?a="":"number"==typeof a?a=String(a):"string"!=typeof a&&(c=!1)),c&&r?u[u.length-1]+=a:u===i?u=[a]:u.push(a),r=c;var h=new n;return h.nodeName=e,h.children=u,h.attributes=null==t?void 0:t,h.key=null==t?void 0:t.key,void 0!==o.vnode&&o.vnode(h),h}function c(e,t){for(var r in t)e[r]=t[r];return e}var l="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout;function u(e,t){return a(e.nodeName,c(c({},e.attributes),t),arguments.length>2?[].slice.call(arguments,2):e.children)}var h=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,p=[];function d(e){!e._dirty&&(e._dirty=!0)&&1==p.push(e)&&(o.debounceRendering||l)(f)}function f(){var e,t=p;for(p=[];e=t.pop();)e._dirty&&U(e)}function m(e,t,r){return"string"==typeof t||"number"==typeof t?void 0!==e.splitText:"string"==typeof t.nodeName?!e._componentConstructor&&g(e,t.nodeName):r||e._componentConstructor===t.nodeName}function g(e,t){return e.normalizedNodeName===t||e.nodeName.toLowerCase()===t.toLowerCase()}function _(e){var t=c({},e.attributes);t.children=e.children;var r=e.nodeName.defaultProps;if(void 0!==r)for(var n in r)void 0===t[n]&&(t[n]=r[n]);return t}function v(e){var t=e.parentNode;t&&t.removeChild(e)}function w(e,t,r,n,o){if("className"===t&&(t="class"),"key"===t);else if("ref"===t)r&&r(null),n&&n(e);else if("class"!==t||o)if("style"===t){if(n&&"string"!=typeof n&&"string"!=typeof r||(e.style.cssText=n||""),n&&"object"==typeof n){if("string"!=typeof r)for(var s in r)s in n||(e.style[s]="");for(var s in n)e.style[s]="number"==typeof n[s]&&!1===h.test(s)?n[s]+"px":n[s]}}else if("dangerouslySetInnerHTML"===t)n&&(e.innerHTML=n.__html||"");else if("o"==t[0]&&"n"==t[1]){var i=t!==(t=t.replace(/Capture$/,""));t=t.toLowerCase().substring(2),n?r||e.addEventListener(t,y,i):e.removeEventListener(t,y,i),(e._listeners||(e._listeners={}))[t]=n}else if("list"!==t&&"type"!==t&&!o&&t in e){try{e[t]=null==n?"":n}catch(e){}null!=n&&!1!==n||"spellcheck"==t||e.removeAttribute(t)}else{var a=o&&t!==(t=t.replace(/^xlink:?/,""));null==n||!1===n?a?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.removeAttribute(t):"function"!=typeof n&&(a?e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),n):e.setAttribute(t,n))}else e.className=n||""}function y(e){return this._listeners[e.type](o.event&&o.event(e)||e)}var b=[],x=0,T=!1,C=!1;function P(){for(var e;e=b.pop();)o.afterMount&&o.afterMount(e),e.componentDidMount&&e.componentDidMount()}function M(e,t,r,n,o,s){x++||(T=null!=o&&void 0!==o.ownerSVGElement,C=null!=e&&!("__preactattr_"in e));var i=D(e,t,r,n,s);return o&&i.parentNode!==o&&o.appendChild(i),--x||(C=!1,s||P()),i}function D(e,t,r,n,o){var s=e,i=T;if(null!=t&&"boolean"!=typeof t||(t=""),"string"==typeof t||"number"==typeof t)return e&&void 0!==e.splitText&&e.parentNode&&(!e._component||o)?e.nodeValue!=t&&(e.nodeValue=t):(s=document.createTextNode(t),e&&(e.parentNode&&e.parentNode.replaceChild(s,e),A(e,!0))),s.__preactattr_=!0,s;var a=t.nodeName;if("function"==typeof a)return function(e,t,r,n){var o=e&&e._component,s=o,i=e,a=o&&e._componentConstructor===t.nodeName,c=a,l=_(t);for(;o&&!c&&(o=o._parentComponent);)c=o.constructor===t.nodeName;o&&c&&(!n||o._component)?(L(o,l,3,r,n),e=o.base):(s&&!a&&(V(s),e=i=null),o=R(t.nodeName,l,r),e&&!o.nextBase&&(o.nextBase=e,i=null),L(o,l,1,r,n),e=o.base,i&&e!==i&&(i._component=null,A(i,!1)));return e}(e,t,r,n);if(T="svg"===a||"foreignObject"!==a&&T,a=String(a),(!e||!g(e,a))&&(s=function(e,t){var r=t?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return r.normalizedNodeName=e,r}(a,T),e)){for(;e.firstChild;)s.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(s,e),A(e,!0)}var c=s.firstChild,l=s.__preactattr_,u=t.children;if(null==l){l=s.__preactattr_={};for(var h=s.attributes,p=h.length;p--;)l[h[p].name]=h[p].value}return!C&&u&&1===u.length&&"string"==typeof u[0]&&null!=c&&void 0!==c.splitText&&null==c.nextSibling?c.nodeValue!=u[0]&&(c.nodeValue=u[0]):(u&&u.length||null!=c)&&function(e,t,r,n,o){var s,i,a,c,l,u=e.childNodes,h=[],p={},d=0,f=0,g=u.length,_=0,w=t?t.length:0;if(0!==g)for(var y=0;y<g;y++){var b=u[y],x=b.__preactattr_,T=w&&x?b._component?b._component.__key:x.key:null;null!=T?(d++,p[T]=b):(x||(void 0!==b.splitText?!o||b.nodeValue.trim():o))&&(h[_++]=b)}if(0!==w)for(var y=0;y<w;y++){c=t[y],l=null;var T=c.key;if(null!=T)d&&void 0!==p[T]&&(l=p[T],p[T]=void 0,d--);else if(f<_)for(s=f;s<_;s++)if(void 0!==h[s]&&m(i=h[s],c,o)){l=i,h[s]=void 0,s===_-1&&_--,s===f&&f++;break}l=D(l,c,r,n),a=u[y],l&&l!==e&&l!==a&&(null==a?e.appendChild(l):l===a.nextSibling?v(a):e.insertBefore(l,a))}if(d)for(var y in p)void 0!==p[y]&&A(p[y],!1);for(;f<=_;)void 0!==(l=h[_--])&&A(l,!1)}(s,u,r,n,C||null!=l.dangerouslySetInnerHTML),function(e,t,r){var n;for(n in r)t&&null!=t[n]||null==r[n]||w(e,n,r[n],r[n]=void 0,T);for(n in t)"children"===n||"innerHTML"===n||n in r&&t[n]===("value"===n||"checked"===n?e[n]:r[n])||w(e,n,r[n],r[n]=t[n],T)}(s,t.attributes,l),T=i,s}function A(e,t){var r=e._component;r?V(r):(null!=e.__preactattr_&&e.__preactattr_.ref&&e.__preactattr_.ref(null),!1!==t&&null!=e.__preactattr_||v(e),k(e))}function k(e){for(e=e.lastChild;e;){var t=e.previousSibling;A(e,!0),e=t}}var S=[];function R(e,t,r){var n,o=S.length;for(e.prototype&&e.prototype.render?(n=new e(t,r),z.call(n,t,r)):((n=new z(t,r)).constructor=e,n.render=E);o--;)if(S[o].constructor===e)return n.nextBase=S[o].nextBase,S.splice(o,1),n;return n}function E(e,t,r){return this.constructor(e,r)}function L(e,t,r,n,s){e._disable||(e._disable=!0,e.__ref=t.ref,e.__key=t.key,delete t.ref,delete t.key,void 0===e.constructor.getDerivedStateFromProps&&(!e.base||s?e.componentWillMount&&e.componentWillMount():e.componentWillReceiveProps&&e.componentWillReceiveProps(t,n)),n&&n!==e.context&&(e.prevContext||(e.prevContext=e.context),e.context=n),e.prevProps||(e.prevProps=e.props),e.props=t,e._disable=!1,0!==r&&(1!==r&&!1===o.syncComponentUpdates&&e.base?d(e):U(e,1,s)),e.__ref&&e.__ref(e))}function U(e,t,r,n){if(!e._disable){var s,i,a,l=e.props,u=e.state,h=e.context,p=e.prevProps||l,d=e.prevState||u,f=e.prevContext||h,m=e.base,g=e.nextBase,v=m||g,w=e._component,y=!1,T=f;if(e.constructor.getDerivedStateFromProps&&(u=c(c({},u),e.constructor.getDerivedStateFromProps(l,u)),e.state=u),m&&(e.props=p,e.state=d,e.context=f,2!==t&&e.shouldComponentUpdate&&!1===e.shouldComponentUpdate(l,u,h)?y=!0:e.componentWillUpdate&&e.componentWillUpdate(l,u,h),e.props=l,e.state=u,e.context=h),e.prevProps=e.prevState=e.prevContext=e.nextBase=null,e._dirty=!1,!y){s=e.render(l,u,h),e.getChildContext&&(h=c(c({},h),e.getChildContext())),m&&e.getSnapshotBeforeUpdate&&(T=e.getSnapshotBeforeUpdate(p,d));var C,D,k=s&&s.nodeName;if("function"==typeof k){var S=_(s);(i=w)&&i.constructor===k&&S.key==i.__key?L(i,S,1,h,!1):(C=i,e._component=i=R(k,S,h),i.nextBase=i.nextBase||g,i._parentComponent=e,L(i,S,0,h,!1),U(i,1,r,!0)),D=i.base}else a=v,(C=w)&&(a=e._component=null),(v||1===t)&&(a&&(a._component=null),D=M(a,s,h,r||!m,v&&v.parentNode,!0));if(v&&D!==v&&i!==w){var E=v.parentNode;E&&D!==E&&(E.replaceChild(D,v),C||(v._component=null,A(v,!1)))}if(C&&V(C),e.base=D,D&&!n){for(var z=e,N=e;N=N._parentComponent;)(z=N).base=D;D._component=z,D._componentConstructor=z.constructor}}for(!m||r?b.unshift(e):y||(e.componentDidUpdate&&e.componentDidUpdate(p,d,T),o.afterUpdate&&o.afterUpdate(e));e._renderCallbacks.length;)e._renderCallbacks.pop().call(e);x||n||P()}}function V(e){o.beforeUnmount&&o.beforeUnmount(e);var t=e.base;e._disable=!0,e.componentWillUnmount&&e.componentWillUnmount(),e.base=null;var r=e._component;r?V(r):t&&(t.__preactattr_&&t.__preactattr_.ref&&t.__preactattr_.ref(null),e.nextBase=t,v(t),S.push(e),k(t)),e.__ref&&e.__ref(null)}function z(e,t){this._dirty=!0,this.context=t,this.props=e,this.state=this.state||{},this._renderCallbacks=[]}function N(e,t,r){return M(r,e,{},!1,t,!1)}c(z.prototype,{setState:function(e,t){this.prevState||(this.prevState=this.state),this.state=c(c({},this.state),"function"==typeof e?e(this.state,this.props):e),t&&this._renderCallbacks.push(t),d(this)},forceUpdate:function(e){e&&this._renderCallbacks.push(e),U(this,2)},render:function(){}});var O={h:a,createElement:a,cloneElement:u,Component:z,render:N,rerender:f,options:o};t.default=O},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];class s{constructor(e=o){this.values=e,this.valueAt=this.valueAt.bind(this)}toFloat32Array(){const e=this.valueAt;return new Float32Array([e(1,1),e(2,1),e(3,1),e(4,1),e(1,2),e(2,2),e(3,2),e(4,2),e(1,3),e(2,3),e(3,3),e(4,3),e(1,4),e(2,4),e(3,4),e(4,4)])}valueAt(e,t){return this.values[e-1][t-1]}translate(e,t,r){const o=n.Vector3D.fromVectorOrCoords(e,t,r);return this.multiply(new s([[1,0,0,o.x],[0,1,0,o.y],[0,0,1,o.z],[0,0,0,1]]))}scale(e,t,r){return void 0===t&&(t=e),void 0===r&&(r=t),this.multiply(new s([[e,0,0,0],[0,t,0,0],[0,0,r,0],[0,0,0,1]]))}rotateX(e){const t=Math.cos(e),r=Math.sin(e);return this.multiply(new s([[1,0,0,0],[0,t,r,0],[0,-r,t,0],[0,0,0,1]]))}rotateY(e){const t=Math.cos(e),r=Math.sin(e);return this.multiply(new s([[t,0,-r,0],[0,1,0,0],[r,0,t,0],[0,0,0,1]]))}rotateZ(e){const t=Math.cos(e),r=Math.sin(e);return this.multiply(new s([[t,-r,0,0],[r,t,0,0],[0,0,1,0],[0,0,0,1]]))}multiply(e){const t=this.transformVector(e.column(1)),r=this.transformVector(e.column(2)),n=this.transformVector(e.column(3)),o=this.transformVector(e.column(4));return new s([[t.x,r.x,n.x,o.x],[t.y,r.y,n.y,o.y],[t.z,r.z,n.z,o.z],[t.w,r.w,n.w,o.w]])}map(e){return new s(this.values.map(t=>t.map(e)))}multiplyByConstant(e){return this.map(t=>t*e)}static perspectiveProjection(e){const{near:t,far:r,left:n,right:o,top:i,bottom:a}=e,c=o-n,l=i-a,u=r-t,h=2*t;return new s([[h/c,0,(o+n)/c,0],[0,h/l,(i+a)/l,0],[0,0,-(r+t)/u,-2*r*t/u],[0,0,-1,0]])}transformPoints(e){return e.map(e=>this.transformVector(e))}transformVector(e){const t=this.valueAt;return new n.Vector3D(t(1,1)*e.x+t(1,2)*e.y+t(1,3)*e.z+t(1,4)*e.w,t(2,1)*e.x+t(2,2)*e.y+t(2,3)*e.z+t(2,4)*e.w,t(3,1)*e.x+t(3,2)*e.y+t(3,3)*e.z+t(3,4)*e.w,t(4,1)*e.x+t(4,2)*e.y+t(4,3)*e.z+t(4,4)*e.w)}column(e){const t=this.valueAt;return new n.Vector3D(t(1,e),t(2,e),t(3,e),t(4,e))}}t.Matrix3D=s},function(e,t,r){"use strict";function n(e,t,r){const n=e.createShader(t);if(!n)throw new Error("gl.createShader() failed!");if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){const t="Compiling shader failed: "+e.getShaderInfoLog(n);throw e.deleteShader(n),new Error(t)}return n}Object.defineProperty(t,"__esModule",{value:!0}),t.getAttribLocation=function(e,t,r){const n=e.getAttribLocation(t,r);if(-1===n)throw new Error(`Unable to find attribute '${r}'!`);return n};t.GlProgram=class{constructor(e,t,r){this.gl=e;const o=n(e,WebGLRenderingContext.VERTEX_SHADER,t),s=n(e,WebGLRenderingContext.FRAGMENT_SHADER,r);this.program=function(e,t,r){const n=e.createProgram();if(!n)throw new Error("gl.createProgram() failed!");if(e.attachShader(n,t),e.attachShader(n,r),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){const t="Linking program failed: "+e.getProgramInfoLog(n);throw e.deleteProgram(n),new Error(t)}return n}(e,o,s)}activate(){this.gl.useProgram(this.program)}};class o{constructor(e,t){this.program=e,this.location=function(e,t,r){const n=e.getUniformLocation(t,r);if(null===n)throw new Error(`Unable to find uniform '${r}'!`);return n}(e.gl,e.program,t)}}t.GlUniformVector3D=class extends o{set(e){this.program.gl.uniform4fv(this.location,[e.x,e.y,e.z,e.w])}};t.GlUniformFloat=class extends o{set(e){this.program.gl.uniform1f(this.location,e)}};t.GlUniformMatrix3D=class extends o{set(e){this.program.gl.uniformMatrix4fv(this.location,!1,e.toFloat32Array())}};t.GlUniformBoolean=class extends o{set(e){this.program.gl.uniform1f(this.location,e?1:0)}},t.setupBuffer=function(e,t){const r=e.createBuffer();if(null===r)throw new Error("gl.createBuffer() failed!");return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),r}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(1),o=r(5),s=r(7),i=r(8);window.addEventListener("DOMContentLoaded",()=>{const e=new i.App(s.getElement("canvas","#canvas"));e.run(),n.render(n.h(o.AppUi,{app:e}),s.getElement("div","#app-ui"))})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(1),o=r(6);function s(e){const t=()=>e.onToggle(!e.checked);return n.h("label",null,n.h("input",{type:"checkbox",checked:e.checked,onClick:t})," ",e.label," ",e.hotkey&&n.h(o.Hotkey,{onPressed:t,hotkey:e.hotkey}))}t.AppUi=class extends n.Component{constructor(e){super(e),this.state=e.app.getUi()}componentDidUpdate(){this.props.app.dispatchAction({type:"uiupdate",ui:this.state})}render(e,t){return n.h("div",{className:"ui-wrapper"},n.h("div",{className:"ui"},n.h(s,{checked:t.showColliders,label:"Show colliders",hotkey:"c",onToggle:e=>this.setState({showColliders:e})}),n.h(s,{checked:t.isPaused,label:"Pause",hotkey:"p",onToggle:e=>this.setState({isPaused:e})}),n.h(s,{checked:t.showZBuffer,label:"Show z-buffer",hotkey:"z",onToggle:e=>this.setState({showZBuffer:e})}),!t.showZBuffer&&n.h(s,{checked:t.enableLighting,label:"Enable lighting",hotkey:"l",onToggle:e=>this.setState({enableLighting:e})})))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(1);class o{constructor(){this.mapping=new Map,document.body.addEventListener("keypress",e=>this.handleEvent(e))}handleEvent(e){const t=this.mapping.get(e.key.toLowerCase());t&&t()}set(e,t){this.mapping.set(e,t)}unset(e){this.mapping.delete(e)}}t.KeyboardMap=o;const s=new o;t.Hotkey=class extends n.Component{handlePress(){this.props.onPressed()}componentDidMount(){s.set(this.props.hotkey,this.handlePress.bind(this))}componentWillUnmount(){s.unset(this.props.hotkey)}render(e){return n.h("kbd",null,e.hotkey)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=function(e,t,r=document){const n=`${e}${t}`,o=r.querySelector(n);if(!o)throw new Error(`Couldn't find any elements matching "${n}"`);return o}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(3),o=r(9),s=r(2),i=r(0),a=r(10),c=r(11),l=r(13),u=r(14),h=r(15),p=r(16),d=r(17),f=r(18),m=!1,g=p.Color.fromHex("#ed225d"),_=p.Color.fromHex("#2d7bb6");class v extends n.GlProgram{constructor(e){super(e,d,f),this.projectionTransform=new n.GlUniformMatrix3D(this,"u_projection_transform"),this.viewTransform=new n.GlUniformMatrix3D(this,"u_view_transform"),this.modelTransform=new n.GlUniformMatrix3D(this,"u_model_transform"),this.color=new n.GlUniformVector3D(this,"u_color"),this.light=new n.GlUniformVector3D(this,"u_light"),this.normal=new n.GlUniformVector3D(this,"u_normal"),this.shade=new n.GlUniformBoolean(this,"u_shade"),this.positionAttributeLocation=n.getAttribLocation(e,this.program,"a_position"),this.showZBuffer=new n.GlUniformBoolean(this,"u_show_z_buffer")}}class w{constructor(e){this.colliderScale=.5,this.state=e;const t=(new s.Matrix3D).rotateZ(e.orbitTheta).translate(e.distanceFromCenter,0,e.z).scale(e.scale).rotateY(e.shipTheta);this.transform=t}static createRandom(e){return new w({orbitTheta:Math.random(),orbitThetaVelocity:.01*Math.random(),distanceFromCenter:Math.random(),scale:.5,shipTheta:Math.random(),shipThetaVelocity:.05*Math.random(),z:Math.random(),color:g,...e})}get colliderRadius(){return this.state.scale*this.colliderScale}getColliderTransform(){return this.transform.scale(this.colliderScale)}center(){return this.transform.transformVector(new i.Vector3D)}doesRayIntersect(e){return null!==h.getRaySphereIntersection(e,this.center(),this.colliderRadius)}withColor(e){return new w({...this.state,color:e})}update(){const{state:e}=this;return new w({...e,orbitTheta:e.orbitTheta+e.orbitThetaVelocity,shipTheta:e.shipTheta+e.shipThetaVelocity})}}w.normal=new i.Vector3D(0,0,1);class y{constructor(e){const t=e.cameraTransform.matrix.transformVector(new i.Vector3D),r=l.screenCoordsToWorld(e.canvas,e.coords,e.perspective,e.cameraTransform.matrix);this.ray=u.Ray3D.fromTo(t,r),this.points=c.makeRayPoints(this.ray),this.renderer=new o.Points3DRenderer(e.program,this.points)}}class b{constructor(e){this.state=e,this.projectionTransform=s.Matrix3D.perspectiveProjection(e.perspective),this.cameraTransform=(new a.InvertibleTransforms3D).rotateY(e.cameraRotation).translate(0,0,2.25),this.viewTransform=this.cameraTransform.inverse()}update(){const{state:e}=this;return new b({...e,cameraRotation:e.cameraRotation+.001,spaceships:e.spaceships.map(e=>e.update())})}shootRay(e){const{state:t}=this;return new b({...t,spaceships:t.spaceships.map(t=>t.withColor(t.doesRayIntersect(e.ray)?_:g)),ray:e})}}t.App=class{constructor(e){this.canvas=e,this.queuedActions=[],this.ui={showColliders:!1,isPaused:!1,showZBuffer:!0,enableLighting:!0};const t=e.getContext("webgl");if(!t)throw new Error("webgl is not supported on this browser!");this.gl=t;const r=new v(t);this.program=r,this.spaceshipRenderer=new o.Points3DRenderer(r,c.makeSpaceship()),this.groundRenderer=new o.Points3DRenderer(r,c.makeGround()),this.circleRenderer=new o.Points3DRenderer(r,c.makeCircle()),e.addEventListener("click",e=>{this.ui.isPaused||this.queuedActions.push({type:"click",point:{x:e.offsetX,y:e.offsetY}})})}dispatchAction(e){this.queuedActions.push(e)}getUi(){return this.ui}render({scene:e,ui:t}){const{gl:r,program:n}=this;r.viewport(0,0,r.canvas.width,r.canvas.height),r.enable(r.DEPTH_TEST),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),n.activate(),n.showZBuffer.set(t.showZBuffer),n.color.set(p.BLACK),n.light.set(e.cameraTransform.matrix.transformVector(new i.Vector3D)),n.projectionTransform.set(e.projectionTransform),n.viewTransform.set(e.viewTransform),n.shade.set(!1),e.state.ray&&m&&(e.state.ray.renderer.setupForDrawing(),n.modelTransform.set(new s.Matrix3D),e.state.ray.renderer.draw(r.LINES)),this.groundRenderer.setupForDrawing(),n.modelTransform.set(new s.Matrix3D),this.groundRenderer.draw(r.LINES),this.spaceshipRenderer.setupForDrawing(),n.shade.set(t.enableLighting),n.normal.set(w.normal),e.state.spaceships.forEach(e=>{n.color.set(e.state.color),n.modelTransform.set(e.transform),this.spaceshipRenderer.draw()}),n.shade.set(!1),t.showColliders&&(this.circleRenderer.setupForDrawing(),e.state.spaceships.forEach(e=>{const t=e.getColliderTransform();n.color.set(e.state.color),function(e,t,r){[e,e.rotateX(Math.PI/2),e.rotateY(Math.PI/2)].forEach(e=>{t.set(e),r.draw(WebGLRenderingContext.LINE_LOOP)})}(t,n.modelTransform,this.circleRenderer)}))}processAction({scene:e,ui:t},r){switch(r.type){case"click":return{scene:e.shootRay(new y({coords:r.point,program:this.program,canvas:this.canvas,cameraTransform:e.cameraTransform,perspective:e.state.perspective})),ui:t};case"tick":return{scene:e.update(),ui:t};case"uiupdate":return{scene:e,ui:r.ui}}}createInitialScene(){return new b({perspective:{top:1,bottom:-1,right:1,left:-1,near:1,far:4},spaceships:function(e=30){const t=[];for(let r=0;r<e;r++)t.push(w.createRandom({z:r/e*2-1}));return t}(),cameraRotation:0})}run(){let e={scene:this.createInitialScene(),ui:this.ui};const t=()=>{this.render(e);const r=[...this.queuedActions];this.queuedActions=[],e.ui.isPaused||r.push({type:"tick"});for(let t of r)e=this.processAction(e,t);window.requestAnimationFrame(t)};t()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(3);t.Points3DRenderer=class{constructor(e,t){this.program=e,this.points=t;const{gl:r}=e;this.buffer=n.setupBuffer(r,t.toFloat32Array())}setupForDrawing(){const{gl:e,positionAttributeLocation:t}=this.program;e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,this.buffer);const r=e.FLOAT;e.vertexAttribPointer(t,3,r,!1,0,0)}draw(e=WebGLRenderingContext.TRIANGLES){const{gl:t}=this.program,r=this.points.length;t.drawArrays(e,0,r)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(2),o=r(0);class s{constructor(e=new n.Matrix3D,t=[]){this.matrix=e,this.ops=t}addOp(e,t){return new s(e,[t,...this.ops])}translate(e,t,r){const n=o.Vector3D.fromVectorOrCoords(e,t,r);return this.addOp(this.matrix.translate(n),e=>e.translate(n.times(-1)))}rotateX(e){return this.addOp(this.matrix.rotateX(e),t=>t.rotateX(-e))}rotateY(e){return this.addOp(this.matrix.rotateY(e),t=>t.rotateY(-e))}rotateZ(e){return this.addOp(this.matrix.rotateZ(e),t=>t.rotateZ(-e))}inverse(){let e=new n.Matrix3D;for(let t of this.ops)e=t(e);return e}}t.InvertibleTransforms3D=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(12),o=r(0),s=r(2);t.makeSpaceship=function(){const e=(new s.Matrix3D).translate(0,-.25,0),t=(new s.Matrix3D).scale(-1,1,1),r=e.transformPoints(n.Points3D.fromArray([-.5,0,0,0,.75,0,0,.15,0]));return r.concat(t.transformPoints(r))},t.makeGround=function(e=-1,t=-1,r=2,o=20){const s=[];let i=t,a=t,c=1/o;for(let t=0;t<=o;t++)s.push(i,e,a),s.push(i,e,a+r),i+=r*c;i=t;for(let t=0;t<=o;t++)s.push(i,e,a),s.push(i+r,e,a),a+=r*c;return n.Points3D.fromArray(s)},t.makeRayPoints=function(e,t=1,r=5){let o=e.origin;const s=e.direction.times(r/t),i=[];for(let e=0;e<t;e++)i.push(o.x,o.y,o.z),o=o.plus(s),i.push(o.x,o.y,o.z);return n.Points3D.fromArray(i)},t.makeCircle=function(e=20){const t=[],r=new o.Vector3D(1,0,0);for(let n=0;n<e;n++){const o=(new s.Matrix3D).rotateZ(2*Math.PI*(n/e)).transformVector(r);t.push(o.x,o.y,o.z)}return n.Points3D.fromArray(t)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);class o{constructor(e){this.array=e}toFloat32Array(){const{array:e}=this,t=new Float32Array(3*e.length);let r=0;for(let n=0;n<t.length;n+=3)t[n]=e[r].x,t[n+1]=e[r].y,t[n+2]=e[r].z,r+=1;return t}concat(e){const t=this.array.concat(e.array);return new o(t)}map(e){return new o(this.array.map(e))}get length(){return this.array.length}static fromArray(e){const t=e.length/3,r=new Array(t);let s=0;for(let o=0;o<t;o++){const t=e[s],i=e[s+1],a=e[s+2];r[o]=new n.Vector3D(t,i,a),s+=3}return new o(r)}}t.Points3D=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);t.screenCoordsToWorld=function(e,t,r,o){const s=function(e,t,r){const o=r.right-r.left,s=r.top-r.bottom,i=t.x/e.width,a=(e.height-t.y)/e.height,c=r.left+i*o,l=r.bottom+a*s,u=-r.near;return new n.Vector3D(c,l,u)}(e,t,r);return o.transformVector(s)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e,t){this.origin=e,this.direction=t.normalize()}pointAlong(e){return this.origin.plus(this.direction.times(e))}static fromTo(e,t){const r=t.minus(e);return new n(e,r)}}t.Ray3D=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getRaySphereIntersection=function(e,t,r){const n=e.origin.minus(t),o=e.direction.dot(n),s=o*o-(n.dot(n)-r*r);if(s<0)return null;const i=Math.sqrt(s),a=[-o+i,-o-i].filter(e=>e>=0);if(0===a.length)return null;const c=a.sort((e,t)=>e-t)[0];return e.pointAlong(c)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);class o extends n.Vector3D{constructor(e,t,r,n=1){super(e,t,r,n)}static fromHex(e){"#"==(e=e.toLowerCase())[0]&&(e=e.slice(1));const t=e=>parseInt(e,16)/255,r=t(e.substr(0,2)),n=t(e.substr(2,2)),s=t(e.substr(4,2));return new o(r,n,s)}}t.Color=o,t.BLACK=new o(0,0,0)},function(e,t){e.exports="precision mediump float;\n\n/**\n * Attributes\n *\n * These are passed into us and generally change\n * from one execution of our shader program to the next\n * during a render call.\n */\n\n/** The position of the vertex, in object space. */\nattribute vec4 a_position;\n\n/**\n * Uniforms\n *\n * These are passed into us and do not change from\n * one execution of our shader program to the next\n * during a render call.\n */\n\n/** The color of the vertex. */\nuniform vec4 u_color;\n\n/** The vertex's normal in object space. */\nuniform vec4 u_normal;\n\n/** The position of the light in world coordinates. */\nuniform vec4 u_light;\n\n/**\n * Whether or not to actually shade the vertex based on\n * the current lighting.\n */\nuniform bool u_shade;\n\n/** Matrix to convert from eye space to clip coordinates. */\nuniform mat4 u_projection_transform;\n\n/** Matrix to convert from world space to eye space. */\nuniform mat4 u_view_transform;\n\n/** Matrix to convert from object space to world space. */\nuniform mat4 u_model_transform;\n\n/**\n * Varyings\n *\n * These are passed from us to the fragment shader.\n */\n\n/** The color of the vertex. */\nvarying vec4 v_color;\n\nvoid main() {\n  gl_Position = u_projection_transform * u_view_transform * u_model_transform * a_position;\n\n  float light_amount = 1.0;\n\n  if (u_shade) {\n    float ambient_light_amount = 0.25;\n    float max_illumination = 1.0 - ambient_light_amount;\n\n    // The surface normal, in world space.\n    vec4 world_normal = normalize(\n      u_model_transform * u_normal -\n      u_model_transform * vec4(0, 0, 0, 1)\n    );\n\n    // The direction from the origin to the light source, in world space.\n    vec4 world_light = normalize(u_light);\n\n    // Based on the angle between the surface normal and the\n    // light, shade the vertex accordingly.\n    //\n    // Note that we're taking the absolute value of the dot\n    // product because we're assuming that the shape we're\n    // drawing is two-sided, and that the side of the shape\n    // visible to the user is also the side that faces the\n    // light.\n    float illumination = abs(dot(world_normal, world_light));\n\n    light_amount = ambient_light_amount + illumination * max_illumination;\n  }\n\n  v_color = vec4(light_amount * vec3(u_color), 1.0);\n}\n"},function(e,t){e.exports="precision mediump float;\n\n/**\n * Uniforms\n *\n * These are passed into us and do not change from\n * one execution of our shader program to the next\n * during a render call.\n */\n\n/** Whether to color the fragment based on its z-buffer location. */\nuniform bool u_show_z_buffer;\n\n/**\n * Varyings\n *\n * These are passed into us from the vertex shader.\n */\n\n/** The color of the fragment. */\nvarying vec4 v_color;\n\nvoid main() {\n  if (u_show_z_buffer) {\n    // This essentially visualizes the z-buffer. Taken from:\n    //\n    //   https://learnopengl.com/Advanced-OpenGL/Depth-testing\n    gl_FragColor = vec4(vec3(gl_FragCoord.z), 1.0);\n  } else {\n    gl_FragColor = v_color;\n  }\n}\n"}]);
//# sourceMappingURL=main.bundle.js.map