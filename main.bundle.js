!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e=0,t=0,n=0,r=1){this.x=e,this.y=t,this.z=n,this.w=r}perspectiveDivide(){const{x:e,y:t,z:n,w:o}=this;return new r(e/o,t/o,n/o)}minus(e){const{x:t,y:n,z:o,w:s}=this;return new r(t-e.x,n-e.y,o-e.z,s)}plus(e){const{x:t,y:n,z:o,w:s}=this;return new r(t+e.x,n+e.y,o+e.z,s)}times(e){const{x:t,y:n,z:o,w:s}=this;return new r(t*e,n*e,o*e,s)}dot(e){const{x:t,y:n,z:r,w:o}=this;return t*e.x+n*e.y+r*e.z}normalize(){const{x:e,y:t,z:n,w:o}=this,s=Math.sqrt(e*e+t*t+n*n);return new r(e/s,t/s,n/s,o)}static fromVectorOrCoords(e,t,n){return n=e instanceof r?e.z:n||0,t=e instanceof r?e.y:t||0,e=e instanceof r?e.x:e,new r(e,t,n)}}t.Vector3D=r},function(e,t,n){"use strict";n.r(t),n.d(t,"h",function(){return a}),n.d(t,"createElement",function(){return a}),n.d(t,"cloneElement",function(){return u}),n.d(t,"Component",function(){return z}),n.d(t,"render",function(){return B}),n.d(t,"rerender",function(){return f}),n.d(t,"options",function(){return o});var r=function(){},o={},s=[],i=[];function a(e,t){var n,a,c,l,u=i;for(l=arguments.length;l-- >2;)s.push(arguments[l]);for(t&&null!=t.children&&(s.length||s.push(t.children),delete t.children);s.length;)if((a=s.pop())&&void 0!==a.pop)for(l=a.length;l--;)s.push(a[l]);else"boolean"==typeof a&&(a=null),(c="function"!=typeof e)&&(null==a?a="":"number"==typeof a?a=String(a):"string"!=typeof a&&(c=!1)),c&&n?u[u.length-1]+=a:u===i?u=[a]:u.push(a),n=c;var h=new r;return h.nodeName=e,h.children=u,h.attributes=null==t?void 0:t,h.key=null==t?void 0:t.key,void 0!==o.vnode&&o.vnode(h),h}function c(e,t){for(var n in t)e[n]=t[n];return e}var l="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout;function u(e,t){return a(e.nodeName,c(c({},e.attributes),t),arguments.length>2?[].slice.call(arguments,2):e.children)}var h=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,d=[];function p(e){!e._dirty&&(e._dirty=!0)&&1==d.push(e)&&(o.debounceRendering||l)(f)}function f(){var e,t=d;for(d=[];e=t.pop();)e._dirty&&L(e)}function m(e,t,n){return"string"==typeof t||"number"==typeof t?void 0!==e.splitText:"string"==typeof t.nodeName?!e._componentConstructor&&g(e,t.nodeName):n||e._componentConstructor===t.nodeName}function g(e,t){return e.normalizedNodeName===t||e.nodeName.toLowerCase()===t.toLowerCase()}function _(e){var t=c({},e.attributes);t.children=e.children;var n=e.nodeName.defaultProps;if(void 0!==n)for(var r in n)void 0===t[r]&&(t[r]=n[r]);return t}function v(e){var t=e.parentNode;t&&t.removeChild(e)}function w(e,t,n,r,o){if("className"===t&&(t="class"),"key"===t);else if("ref"===t)n&&n(null),r&&r(e);else if("class"!==t||o)if("style"===t){if(r&&"string"!=typeof r&&"string"!=typeof n||(e.style.cssText=r||""),r&&"object"==typeof r){if("string"!=typeof n)for(var s in n)s in r||(e.style[s]="");for(var s in r)e.style[s]="number"==typeof r[s]&&!1===h.test(s)?r[s]+"px":r[s]}}else if("dangerouslySetInnerHTML"===t)r&&(e.innerHTML=r.__html||"");else if("o"==t[0]&&"n"==t[1]){var i=t!==(t=t.replace(/Capture$/,""));t=t.toLowerCase().substring(2),r?n||e.addEventListener(t,y,i):e.removeEventListener(t,y,i),(e._listeners||(e._listeners={}))[t]=r}else if("list"!==t&&"type"!==t&&!o&&t in e){try{e[t]=null==r?"":r}catch(e){}null!=r&&!1!==r||"spellcheck"==t||e.removeAttribute(t)}else{var a=o&&t!==(t=t.replace(/^xlink:?/,""));null==r||!1===r?a?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.removeAttribute(t):"function"!=typeof r&&(a?e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),r):e.setAttribute(t,r))}else e.className=r||""}function y(e){return this._listeners[e.type](o.event&&o.event(e)||e)}var b=[],x=0,T=!1,C=!1;function P(){for(var e;e=b.pop();)o.afterMount&&o.afterMount(e),e.componentDidMount&&e.componentDidMount()}function M(e,t,n,r,o,s){x++||(T=null!=o&&void 0!==o.ownerSVGElement,C=null!=e&&!("__preactattr_"in e));var i=A(e,t,n,r,s);return o&&i.parentNode!==o&&o.appendChild(i),--x||(C=!1,s||P()),i}function A(e,t,n,r,o){var s=e,i=T;if(null!=t&&"boolean"!=typeof t||(t=""),"string"==typeof t||"number"==typeof t)return e&&void 0!==e.splitText&&e.parentNode&&(!e._component||o)?e.nodeValue!=t&&(e.nodeValue=t):(s=document.createTextNode(t),e&&(e.parentNode&&e.parentNode.replaceChild(s,e),D(e,!0))),s.__preactattr_=!0,s;var a=t.nodeName;if("function"==typeof a)return function(e,t,n,r){var o=e&&e._component,s=o,i=e,a=o&&e._componentConstructor===t.nodeName,c=a,l=_(t);for(;o&&!c&&(o=o._parentComponent);)c=o.constructor===t.nodeName;o&&c&&(!r||o._component)?(U(o,l,3,n,r),e=o.base):(s&&!a&&(V(s),e=i=null),o=R(t.nodeName,l,n),e&&!o.nextBase&&(o.nextBase=e,i=null),U(o,l,1,n,r),e=o.base,i&&e!==i&&(i._component=null,D(i,!1)));return e}(e,t,n,r);if(T="svg"===a||"foreignObject"!==a&&T,a=String(a),(!e||!g(e,a))&&(s=function(e,t){var n=t?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return n.normalizedNodeName=e,n}(a,T),e)){for(;e.firstChild;)s.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(s,e),D(e,!0)}var c=s.firstChild,l=s.__preactattr_,u=t.children;if(null==l){l=s.__preactattr_={};for(var h=s.attributes,d=h.length;d--;)l[h[d].name]=h[d].value}return!C&&u&&1===u.length&&"string"==typeof u[0]&&null!=c&&void 0!==c.splitText&&null==c.nextSibling?c.nodeValue!=u[0]&&(c.nodeValue=u[0]):(u&&u.length||null!=c)&&function(e,t,n,r,o){var s,i,a,c,l,u=e.childNodes,h=[],d={},p=0,f=0,g=u.length,_=0,w=t?t.length:0;if(0!==g)for(var y=0;y<g;y++){var b=u[y],x=b.__preactattr_,T=w&&x?b._component?b._component.__key:x.key:null;null!=T?(p++,d[T]=b):(x||(void 0!==b.splitText?!o||b.nodeValue.trim():o))&&(h[_++]=b)}if(0!==w)for(var y=0;y<w;y++){c=t[y],l=null;var T=c.key;if(null!=T)p&&void 0!==d[T]&&(l=d[T],d[T]=void 0,p--);else if(f<_)for(s=f;s<_;s++)if(void 0!==h[s]&&m(i=h[s],c,o)){l=i,h[s]=void 0,s===_-1&&_--,s===f&&f++;break}l=A(l,c,n,r),a=u[y],l&&l!==e&&l!==a&&(null==a?e.appendChild(l):l===a.nextSibling?v(a):e.insertBefore(l,a))}if(p)for(var y in d)void 0!==d[y]&&D(d[y],!1);for(;f<=_;)void 0!==(l=h[_--])&&D(l,!1)}(s,u,n,r,C||null!=l.dangerouslySetInnerHTML),function(e,t,n){var r;for(r in n)t&&null!=t[r]||null==n[r]||w(e,r,n[r],n[r]=void 0,T);for(r in t)"children"===r||"innerHTML"===r||r in n&&t[r]===("value"===r||"checked"===r?e[r]:n[r])||w(e,r,n[r],n[r]=t[r],T)}(s,t.attributes,l),T=i,s}function D(e,t){var n=e._component;n?V(n):(null!=e.__preactattr_&&e.__preactattr_.ref&&e.__preactattr_.ref(null),!1!==t&&null!=e.__preactattr_||v(e),k(e))}function k(e){for(e=e.lastChild;e;){var t=e.previousSibling;D(e,!0),e=t}}var S=[];function R(e,t,n){var r,o=S.length;for(e.prototype&&e.prototype.render?(r=new e(t,n),z.call(r,t,n)):((r=new z(t,n)).constructor=e,r.render=E);o--;)if(S[o].constructor===e)return r.nextBase=S[o].nextBase,S.splice(o,1),r;return r}function E(e,t,n){return this.constructor(e,n)}function U(e,t,n,r,s){e._disable||(e._disable=!0,e.__ref=t.ref,e.__key=t.key,delete t.ref,delete t.key,void 0===e.constructor.getDerivedStateFromProps&&(!e.base||s?e.componentWillMount&&e.componentWillMount():e.componentWillReceiveProps&&e.componentWillReceiveProps(t,r)),r&&r!==e.context&&(e.prevContext||(e.prevContext=e.context),e.context=r),e.prevProps||(e.prevProps=e.props),e.props=t,e._disable=!1,0!==n&&(1!==n&&!1===o.syncComponentUpdates&&e.base?p(e):L(e,1,s)),e.__ref&&e.__ref(e))}function L(e,t,n,r){if(!e._disable){var s,i,a,l=e.props,u=e.state,h=e.context,d=e.prevProps||l,p=e.prevState||u,f=e.prevContext||h,m=e.base,g=e.nextBase,v=m||g,w=e._component,y=!1,T=f;if(e.constructor.getDerivedStateFromProps&&(u=c(c({},u),e.constructor.getDerivedStateFromProps(l,u)),e.state=u),m&&(e.props=d,e.state=p,e.context=f,2!==t&&e.shouldComponentUpdate&&!1===e.shouldComponentUpdate(l,u,h)?y=!0:e.componentWillUpdate&&e.componentWillUpdate(l,u,h),e.props=l,e.state=u,e.context=h),e.prevProps=e.prevState=e.prevContext=e.nextBase=null,e._dirty=!1,!y){s=e.render(l,u,h),e.getChildContext&&(h=c(c({},h),e.getChildContext())),m&&e.getSnapshotBeforeUpdate&&(T=e.getSnapshotBeforeUpdate(d,p));var C,A,k=s&&s.nodeName;if("function"==typeof k){var S=_(s);(i=w)&&i.constructor===k&&S.key==i.__key?U(i,S,1,h,!1):(C=i,e._component=i=R(k,S,h),i.nextBase=i.nextBase||g,i._parentComponent=e,U(i,S,0,h,!1),L(i,1,n,!0)),A=i.base}else a=v,(C=w)&&(a=e._component=null),(v||1===t)&&(a&&(a._component=null),A=M(a,s,h,n||!m,v&&v.parentNode,!0));if(v&&A!==v&&i!==w){var E=v.parentNode;E&&A!==E&&(E.replaceChild(A,v),C||(v._component=null,D(v,!1)))}if(C&&V(C),e.base=A,A&&!r){for(var z=e,B=e;B=B._parentComponent;)(z=B).base=A;A._component=z,A._componentConstructor=z.constructor}}for(!m||n?b.unshift(e):y||(e.componentDidUpdate&&e.componentDidUpdate(d,p,T),o.afterUpdate&&o.afterUpdate(e));e._renderCallbacks.length;)e._renderCallbacks.pop().call(e);x||r||P()}}function V(e){o.beforeUnmount&&o.beforeUnmount(e);var t=e.base;e._disable=!0,e.componentWillUnmount&&e.componentWillUnmount(),e.base=null;var n=e._component;n?V(n):t&&(t.__preactattr_&&t.__preactattr_.ref&&t.__preactattr_.ref(null),e.nextBase=t,v(t),S.push(e),k(t)),e.__ref&&e.__ref(null)}function z(e,t){this._dirty=!0,this.context=t,this.props=e,this.state=this.state||{},this._renderCallbacks=[]}function B(e,t,n){return M(n,e,{},!1,t,!1)}c(z.prototype,{setState:function(e,t){this.prevState||(this.prevState=this.state),this.state=c(c({},this.state),"function"==typeof e?e(this.state,this.props):e),t&&this._renderCallbacks.push(t),p(this)},forceUpdate:function(e){e&&this._renderCallbacks.push(e),L(this,2)},render:function(){}});var N={h:a,createElement:a,cloneElement:u,Component:z,render:B,rerender:f,options:o};t.default=N},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),o=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];class s{constructor(e=o){this.values=e,this.valueAt=this.valueAt.bind(this)}toFloat32Array(){const e=this.valueAt;return new Float32Array([e(1,1),e(2,1),e(3,1),e(4,1),e(1,2),e(2,2),e(3,2),e(4,2),e(1,3),e(2,3),e(3,3),e(4,3),e(1,4),e(2,4),e(3,4),e(4,4)])}valueAt(e,t){return this.values[e-1][t-1]}translate(e,t,n){const o=r.Vector3D.fromVectorOrCoords(e,t,n);return this.multiply(new s([[1,0,0,o.x],[0,1,0,o.y],[0,0,1,o.z],[0,0,0,1]]))}scale(e,t,n){return void 0===t&&(t=e),void 0===n&&(n=t),this.multiply(new s([[e,0,0,0],[0,t,0,0],[0,0,n,0],[0,0,0,1]]))}rotateX(e){const t=Math.cos(e),n=Math.sin(e);return this.multiply(new s([[1,0,0,0],[0,t,n,0],[0,-n,t,0],[0,0,0,1]]))}rotateY(e){const t=Math.cos(e),n=Math.sin(e);return this.multiply(new s([[t,0,-n,0],[0,1,0,0],[n,0,t,0],[0,0,0,1]]))}rotateZ(e){const t=Math.cos(e),n=Math.sin(e);return this.multiply(new s([[t,-n,0,0],[n,t,0,0],[0,0,1,0],[0,0,0,1]]))}multiply(e){const t=this.transformVector(e.column(1)),n=this.transformVector(e.column(2)),r=this.transformVector(e.column(3)),o=this.transformVector(e.column(4));return new s([[t.x,n.x,r.x,o.x],[t.y,n.y,r.y,o.y],[t.z,n.z,r.z,o.z],[t.w,n.w,r.w,o.w]])}map(e){return new s(this.values.map(t=>t.map(e)))}multiplyByConstant(e){return this.map(t=>t*e)}static perspectiveProjection(e){const{near:t,far:n,left:r,right:o,top:i,bottom:a}=e,c=o-r,l=i-a,u=n-t,h=2*t;return new s([[h/c,0,(o+r)/c,0],[0,h/l,(i+a)/l,0],[0,0,-(n+t)/u,-2*n*t/u],[0,0,-1,0]])}transformPoints(e){return e.map(e=>this.transformVector(e))}transformVector(e){const t=this.valueAt;return new r.Vector3D(t(1,1)*e.x+t(1,2)*e.y+t(1,3)*e.z+t(1,4)*e.w,t(2,1)*e.x+t(2,2)*e.y+t(2,3)*e.z+t(2,4)*e.w,t(3,1)*e.x+t(3,2)*e.y+t(3,3)*e.z+t(3,4)*e.w,t(4,1)*e.x+t(4,2)*e.y+t(4,3)*e.z+t(4,4)*e.w)}column(e){const t=this.valueAt;return new r.Vector3D(t(1,e),t(2,e),t(3,e),t(4,e))}}t.Matrix3D=s},function(e,t,n){"use strict";function r(e,t,n){const r=e.createShader(t);if(!r)throw new Error("gl.createShader() failed!");if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){const t="Compiling shader failed: "+e.getShaderInfoLog(r);throw e.deleteShader(r),new Error(t)}return r}Object.defineProperty(t,"__esModule",{value:!0}),t.getAttribLocation=function(e,t,n){const r=e.getAttribLocation(t,n);if(-1===r)throw new Error(`Unable to find attribute '${n}'!`);return r};t.GlProgram=class{constructor(e,t,n){this.gl=e;const o=r(e,WebGLRenderingContext.VERTEX_SHADER,t),s=r(e,WebGLRenderingContext.FRAGMENT_SHADER,n);this.program=function(e,t,n){const r=e.createProgram();if(!r)throw new Error("gl.createProgram() failed!");if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS)){const t="Linking program failed: "+e.getProgramInfoLog(r);throw e.deleteProgram(r),new Error(t)}return r}(e,o,s)}activate(){this.gl.useProgram(this.program)}};class o{constructor(e,t){this.program=e,this.location=function(e,t,n){const r=e.getUniformLocation(t,n);if(null===r)throw new Error(`Unable to find uniform '${n}'!`);return r}(e.gl,e.program,t)}}t.GlUniformVector3D=class extends o{set(e){this.program.gl.uniform4fv(this.location,[e.x,e.y,e.z,e.w])}};t.GlUniformFloat=class extends o{set(e){this.program.gl.uniform1f(this.location,e)}};t.GlUniformMatrix3D=class extends o{set(e){this.program.gl.uniformMatrix4fv(this.location,!1,e.toFloat32Array())}};t.GlUniformBoolean=class extends o{set(e){this.program.gl.uniform1f(this.location,e?1:0)}},t.setupBuffer=function(e,t){const n=e.createBuffer();if(null===n)throw new Error("gl.createBuffer() failed!");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(5),s=n(7),i=n(8);document.addEventListener("touchstart",()=>{},!0),window.addEventListener("DOMContentLoaded",()=>{const e=new i.App(s.getElement("canvas","#canvas"));e.run(),r.render(r.h(o.AppUi,{app:e}),s.getElement("div","#app-ui"))})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(6);function s(e){const t=()=>e.onToggle(!e.checked);return r.h("label",null,r.h("input",{type:"checkbox",checked:e.checked,onClick:t})," ",e.label," ",e.hotkey&&r.h(o.Hotkey,{onPressed:t,hotkey:e.hotkey}))}t.AppUi=class extends r.Component{constructor(e){super(e),this.state=e.app.getUi()}componentDidUpdate(){this.props.app.dispatchAction({type:"uiupdate",ui:this.state})}render(e,t){return r.h("div",{className:"ui-wrapper"},r.h("div",{className:"ui"},r.h(s,{checked:t.showColliders,label:"Show colliders",hotkey:"c",onToggle:e=>this.setState({showColliders:e})}),r.h(s,{checked:t.isPaused,label:"Pause",hotkey:"p",onToggle:e=>this.setState({isPaused:e})}),r.h(s,{checked:t.showZBuffer,label:"Show z-buffer",hotkey:"z",onToggle:e=>this.setState({showZBuffer:e})}),!t.showZBuffer&&r.h(s,{checked:t.enableLighting,label:"Enable lighting",hotkey:"l",onToggle:e=>this.setState({enableLighting:e})})))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1);class o{constructor(){this.mapping=new Map,document.body.addEventListener("keypress",e=>this.handleEvent(e))}handleEvent(e){const t=this.mapping.get(e.key.toLowerCase());t&&t()}set(e,t){this.mapping.set(e,t)}unset(e){this.mapping.delete(e)}}t.KeyboardMap=o;const s=new o;t.Hotkey=class extends r.Component{handlePress(){this.props.onPressed()}componentDidMount(){s.set(this.props.hotkey,this.handlePress.bind(this))}componentWillUnmount(){s.unset(this.props.hotkey)}render(e){return r.h("kbd",null,e.hotkey.toUpperCase())}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=function(e,t,n=document){const r=`${e}${t}`,o=n.querySelector(r);if(!o)throw new Error(`Couldn't find any elements matching "${r}"`);return o}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),o=n(9),s=n(2),i=n(0),a=n(10),c=n(11),l=n(13),u=n(14),h=n(15),d=n(16),p=n(17),f=n(18),m=d.Color.fromHex("#ed225d"),g=d.Color.fromHex("#2d7bb6");class _ extends r.GlProgram{constructor(e){super(e,p,f),this.projectionTransform=new r.GlUniformMatrix3D(this,"u_projection_transform"),this.viewTransform=new r.GlUniformMatrix3D(this,"u_view_transform"),this.modelTransform=new r.GlUniformMatrix3D(this,"u_model_transform"),this.color=new r.GlUniformVector3D(this,"u_color"),this.light=new r.GlUniformVector3D(this,"u_light"),this.normal=new r.GlUniformVector3D(this,"u_normal"),this.shade=new r.GlUniformBoolean(this,"u_shade"),this.positionAttributeLocation=r.getAttribLocation(e,this.program,"a_position"),this.showZBuffer=new r.GlUniformBoolean(this,"u_show_z_buffer")}}class v{constructor(e){this.colliderScale=.5,this.state=e;const t=(new s.Matrix3D).rotateZ(e.orbitTheta).translate(e.distanceFromCenter,0,e.z).scale(e.scale).rotateY(e.shipTheta);this.transform=t}static createRandom(e){return new v({orbitTheta:Math.random(),orbitThetaVelocity:.01*Math.random(),distanceFromCenter:Math.random(),scale:.5,shipTheta:Math.random(),shipThetaVelocity:.05*Math.random(),z:Math.random(),color:m,...e})}get colliderRadius(){return this.state.scale*this.colliderScale}getColliderTransform(){return this.transform.scale(this.colliderScale)}center(){return this.transform.transformVector(new i.Vector3D)}doesRayIntersect(e){return null!==h.getRaySphereIntersection(e,this.center(),this.colliderRadius)}withColor(e){return new v({...this.state,color:e})}update(){const{state:e}=this;return new v({...e,orbitTheta:e.orbitTheta+e.orbitThetaVelocity,shipTheta:e.shipTheta+e.shipThetaVelocity})}}v.normal=new i.Vector3D(0,0,1);class w{constructor(e){const t=e.cameraTransform.matrix.transformVector(new i.Vector3D),n=l.screenCoordsToWorld(e.canvas,e.coords,e.perspective,e.cameraTransform.matrix);this.ray=u.Ray3D.fromTo(t,n)}}class y{constructor(e){this.state=e,this.projectionTransform=s.Matrix3D.perspectiveProjection(e.perspective),this.cameraTransform=(new a.InvertibleTransforms3D).rotateY(e.cameraRotation).translate(0,0,2.25),this.viewTransform=this.cameraTransform.inverse()}update(){const{state:e}=this;return new y({...e,cameraRotation:e.cameraRotation+.001,spaceships:e.spaceships.map(e=>e.update())})}shootRay(e){const{state:t}=this;return new y({...t,spaceships:t.spaceships.map(t=>t.withColor(t.doesRayIntersect(e.ray)?g:m))})}}t.App=class{constructor(e){this.canvas=e,this.queuedActions=[],this.ui={showColliders:!1,isPaused:!1,showZBuffer:!1,enableLighting:!0};const t=e.getContext("webgl");if(!t)throw new Error("webgl is not supported on this browser!");this.gl=t;const n=new _(t);this.program=n,this.spaceshipRenderer=new o.Points3DRenderer(n,c.makeSpaceship()),this.groundRenderer=new o.Points3DRenderer(n,c.makeGround()),this.circleRenderer=new o.Points3DRenderer(n,c.makeCircle()),e.addEventListener("click",t=>{if(this.ui.isPaused)return;const{height:n,width:r}=e.getBoundingClientRect(),o=Math.floor(t.offsetX/r*e.width),s=Math.floor(t.offsetY/n*e.height);this.queuedActions.push({type:"click",point:{x:o,y:s}})})}dispatchAction(e){this.queuedActions.push(e)}getUi(){return this.ui}render({scene:e,ui:t}){const{gl:n,program:r}=this;n.viewport(0,0,n.canvas.width,n.canvas.height),n.enable(n.DEPTH_TEST),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),r.activate(),r.showZBuffer.set(t.showZBuffer),r.color.set(d.BLACK),r.light.set(e.cameraTransform.matrix.transformVector(new i.Vector3D)),r.projectionTransform.set(e.projectionTransform),r.viewTransform.set(e.viewTransform),r.shade.set(!1),this.groundRenderer.setupForDrawing(),r.modelTransform.set(new s.Matrix3D),this.groundRenderer.draw(n.LINES),this.spaceshipRenderer.setupForDrawing(),r.shade.set(t.enableLighting),r.normal.set(v.normal),e.state.spaceships.forEach(e=>{r.color.set(e.state.color),r.modelTransform.set(e.transform),this.spaceshipRenderer.draw()}),r.shade.set(!1),t.showColliders&&(this.circleRenderer.setupForDrawing(),e.state.spaceships.forEach(e=>{const t=e.getColliderTransform();r.color.set(e.state.color),function(e,t,n){[e,e.rotateX(Math.PI/2),e.rotateY(Math.PI/2)].forEach(e=>{t.set(e),n.draw(WebGLRenderingContext.LINE_LOOP)})}(t,r.modelTransform,this.circleRenderer)}))}processAction({scene:e,ui:t},n){switch(n.type){case"click":return{scene:e.shootRay(new w({coords:n.point,canvas:this.canvas,cameraTransform:e.cameraTransform,perspective:e.state.perspective})),ui:t};case"tick":return{scene:e.update(),ui:t};case"uiupdate":return{scene:e,ui:n.ui}}}createInitialScene(){return new y({perspective:{top:1,bottom:-1,right:1,left:-1,near:1,far:4},spaceships:function(e=30){const t=[];for(let n=0;n<e;n++)t.push(v.createRandom({z:n/e*2-1}));return t}(),cameraRotation:0})}run(){let e={scene:this.createInitialScene(),ui:this.ui};const t=()=>{this.render(e);const n=[...this.queuedActions];this.queuedActions=[],e.ui.isPaused||n.push({type:"tick"});for(let t of n)e=this.processAction(e,t);window.requestAnimationFrame(t)};t()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(3);t.Points3DRenderer=class{constructor(e,t){this.program=e,this.points=t;const{gl:n}=e;this.buffer=r.setupBuffer(n,t.toFloat32Array())}setupForDrawing(){const{gl:e,positionAttributeLocation:t}=this.program;e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,this.buffer);const n=e.FLOAT;e.vertexAttribPointer(t,3,n,!1,0,0)}draw(e=WebGLRenderingContext.TRIANGLES){const{gl:t}=this.program,n=this.points.length;t.drawArrays(e,0,n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),o=n(0);class s{constructor(e=new r.Matrix3D,t=[]){this.matrix=e,this.ops=t}addOp(e,t){return new s(e,[t,...this.ops])}translate(e,t,n){const r=o.Vector3D.fromVectorOrCoords(e,t,n);return this.addOp(this.matrix.translate(r),e=>e.translate(r.times(-1)))}rotateX(e){return this.addOp(this.matrix.rotateX(e),t=>t.rotateX(-e))}rotateY(e){return this.addOp(this.matrix.rotateY(e),t=>t.rotateY(-e))}rotateZ(e){return this.addOp(this.matrix.rotateZ(e),t=>t.rotateZ(-e))}inverse(){let e=new r.Matrix3D;for(let t of this.ops)e=t(e);return e}}t.InvertibleTransforms3D=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(12),o=n(0),s=n(2);t.makeSpaceship=function(){const e=(new s.Matrix3D).translate(0,-.25,0),t=(new s.Matrix3D).scale(-1,1,1),n=e.transformPoints(r.Points3D.fromArray([-.5,0,0,0,.75,0,0,.15,0]));return n.concat(t.transformPoints(n))},t.makeGround=function(e=-1,t=-1,n=2,o=20){const s=[];let i=t,a=t,c=1/o;for(let t=0;t<=o;t++)s.push(i,e,a),s.push(i,e,a+n),i+=n*c;i=t;for(let t=0;t<=o;t++)s.push(i,e,a),s.push(i+n,e,a),a+=n*c;return r.Points3D.fromArray(s)},t.makeCircle=function(e=20){const t=[],n=new o.Vector3D(1,0,0);for(let r=0;r<e;r++){const o=(new s.Matrix3D).rotateZ(2*Math.PI*(r/e)).transformVector(n);t.push(o.x,o.y,o.z)}return r.Points3D.fromArray(t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0);class o{constructor(e){this.array=e}toFloat32Array(){const{array:e}=this,t=new Float32Array(3*e.length);let n=0;for(let r=0;r<t.length;r+=3)t[r]=e[n].x,t[r+1]=e[n].y,t[r+2]=e[n].z,n+=1;return t}concat(e){const t=this.array.concat(e.array);return new o(t)}map(e){return new o(this.array.map(e))}get length(){return this.array.length}static fromArray(e){const t=e.length/3,n=new Array(t);let s=0;for(let o=0;o<t;o++){const t=e[s],i=e[s+1],a=e[s+2];n[o]=new r.Vector3D(t,i,a),s+=3}return new o(n)}}t.Points3D=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0);t.screenCoordsToWorld=function(e,t,n,o){const s=function(e,t,n){const o=n.right-n.left,s=n.top-n.bottom,i=t.x/e.width,a=(e.height-t.y)/e.height,c=n.left+i*o,l=n.bottom+a*s,u=-n.near;return new r.Vector3D(c,l,u)}(e,t,n);return o.transformVector(s)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(e,t){this.origin=e,this.direction=t.normalize()}pointAlong(e){return this.origin.plus(this.direction.times(e))}static fromTo(e,t){const n=t.minus(e);return new r(e,n)}}t.Ray3D=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getRaySphereIntersection=function(e,t,n){const r=e.origin.minus(t),o=e.direction.dot(r),s=o*o-(r.dot(r)-n*n);if(s<0)return null;const i=Math.sqrt(s),a=[-o+i,-o-i].filter(e=>e>=0);if(0===a.length)return null;const c=a.sort((e,t)=>e-t)[0];return e.pointAlong(c)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0);class o extends r.Vector3D{constructor(e,t,n,r=1){super(e,t,n,r)}static fromHex(e){"#"==(e=e.toLowerCase())[0]&&(e=e.slice(1));const t=e=>parseInt(e,16)/255,n=t(e.substr(0,2)),r=t(e.substr(2,2)),s=t(e.substr(4,2));return new o(n,r,s)}}t.Color=o,t.BLACK=new o(0,0,0)},function(e,t){e.exports="precision mediump float;\n\n/**\n * Attributes\n *\n * These are passed into us and generally change\n * from one execution of our shader program to the next\n * during a render call.\n */\n\n/** The position of the vertex, in object space. */\nattribute vec4 a_position;\n\n/**\n * Uniforms\n *\n * These are passed into us and do not change from\n * one execution of our shader program to the next\n * during a render call.\n */\n\n/** The color of the vertex. */\nuniform vec4 u_color;\n\n/** The vertex's normal in object space. */\nuniform vec4 u_normal;\n\n/** The position of the light in world coordinates. */\nuniform vec4 u_light;\n\n/**\n * Whether or not to actually shade the vertex based on\n * the current lighting.\n */\nuniform bool u_shade;\n\n/** Matrix to convert from eye space to clip coordinates. */\nuniform mat4 u_projection_transform;\n\n/** Matrix to convert from world space to eye space. */\nuniform mat4 u_view_transform;\n\n/** Matrix to convert from object space to world space. */\nuniform mat4 u_model_transform;\n\n/**\n * Varyings\n *\n * These are passed from us to the fragment shader.\n */\n\n/** The color of the vertex. */\nvarying vec4 v_color;\n\nvoid main() {\n  gl_Position = u_projection_transform * u_view_transform * u_model_transform * a_position;\n\n  float light_amount = 1.0;\n\n  if (u_shade) {\n    float ambient_light_amount = 0.25;\n    float max_illumination = 1.0 - ambient_light_amount;\n\n    // The surface normal, in world space.\n    vec4 world_normal = normalize(\n      u_model_transform * u_normal -\n      u_model_transform * vec4(0, 0, 0, 1)\n    );\n\n    // The direction from the origin to the light source, in world space.\n    vec4 world_light = normalize(u_light);\n\n    // Based on the angle between the surface normal and the\n    // light, shade the vertex accordingly.\n    //\n    // Note that we're taking the absolute value of the dot\n    // product because we're assuming that the shape we're\n    // drawing is two-sided, and that the side of the shape\n    // visible to the user is also the side that faces the\n    // light.\n    float illumination = abs(dot(world_normal, world_light));\n\n    light_amount = ambient_light_amount + illumination * max_illumination;\n  }\n\n  v_color = vec4(light_amount * vec3(u_color), 1.0);\n}\n"},function(e,t){e.exports="precision mediump float;\n\n/**\n * Uniforms\n *\n * These are passed into us and do not change from\n * one execution of our shader program to the next\n * during a render call.\n */\n\n/** Whether to color the fragment based on its z-buffer location. */\nuniform bool u_show_z_buffer;\n\n/**\n * Varyings\n *\n * These are passed into us from the vertex shader.\n */\n\n/** The color of the fragment. */\nvarying vec4 v_color;\n\nvoid main() {\n  if (u_show_z_buffer) {\n    // This essentially visualizes the z-buffer. Taken from:\n    //\n    //   https://learnopengl.com/Advanced-OpenGL/Depth-testing\n    gl_FragColor = vec4(vec3(gl_FragCoord.z), 1.0);\n  } else {\n    gl_FragColor = v_color;\n  }\n}\n"}]);
//# sourceMappingURL=main.bundle.js.map